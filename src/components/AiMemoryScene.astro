---
import { getLocaleFromUrl, getTranslations, getLocalizedPath, getDocsUrl } from '../i18n';

const locale = getLocaleFromUrl(Astro.url);
const t = getTranslations(locale);
const am = t.aiMemoryPage;
const p = (path: string) => getLocalizedPath(path, locale);
const docsUrl = getDocsUrl('/engines/ai', locale);
---

<style>
  .panel-glass { background: rgba(14, 14, 20, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
  .orbit-ring { position: absolute; border-radius: 50%; border: 1px dashed rgba(255, 255, 255, 0.1); top: 50%; left: 50%; transform: translate(-50%, -50%); }
  @keyframes orbit-spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
  @keyframes orbit-spin-reverse { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(-360deg); } }
  @keyframes inner-spin-reverse { 0% { transform: rotate(0deg); } 100% { transform: rotate(-360deg); } }
  @keyframes pulse-glow { 0%, 100% { opacity: 0.6; box-shadow: 0 0 20px rgba(0, 240, 255, 0.2); } 50% { opacity: 1; box-shadow: 0 0 40px rgba(0, 240, 255, 0.5); } }
  .animate-spin-slow { animation: orbit-spin 15s linear infinite; }
  .animate-spin-reverse-slow { animation: orbit-spin-reverse 20s linear infinite; }
  .animate-pulse-glow { animation: pulse-glow 3s ease-in-out infinite; }
</style>

<main class="relative min-h-screen pt-32 flex flex-col lg:flex-row">
  <div class="absolute inset-0 bg-grid-pattern cyber-grid opacity-30 pointer-events-none z-0"></div>
  <div class="absolute inset-0 bg-radial-glow pointer-events-none z-0"></div>

  <!-- Left: Orbit Visualization -->
  <div class="flex-1 relative z-10 p-4 lg:p-10 flex items-center justify-center overflow-hidden min-h-[600px] lg:min-h-auto">
    <div class="relative w-full max-w-4xl aspect-square lg:aspect-video flex items-center justify-center">
      <!-- Outer orbit (fix #1: 600/700px) -->
      <div class="orbit-ring w-[600px] h-[600px] lg:w-[700px] lg:h-[700px] border-slate-700/30 animate-spin-slow">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-[#050508] px-3 py-1 text-xs text-purple-400 border border-purple-500/30 rounded-full shadow-[0_0_15px_rgba(188,19,254,0.2)] whitespace-nowrap">
          {am.orbitOuter1}
        </div>
        <div class="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2 bg-[#050508] px-3 py-1 text-xs text-slate-400 border border-slate-700 rounded-full whitespace-nowrap">
          {am.orbitOuter2}
        </div>
        <!-- fix #2: outer orbit particles (2 purple, counter-rotating) -->
        <div class="absolute top-1/2 left-1/2 w-full h-full -translate-x-1/2 -translate-y-1/2" style="animation: inner-spin-reverse 30s linear infinite;">
          <div class="absolute top-0 left-1/2 w-3 h-3 bg-purple-500 rounded-full blur-[2px] shadow-[0_0_10px_#bc13fe]"></div>
          <div class="absolute bottom-0 left-1/2 w-2 h-2 bg-purple-500/50 rounded-full"></div>
        </div>
      </div>
      <!-- Middle orbit (fix #3: 400/480px) -->
      <div class="orbit-ring w-[400px] h-[400px] lg:w-[480px] lg:h-[480px] border-cyan-500/20 animate-spin-reverse-slow">
        <div class="absolute top-[15%] right-[10%] bg-[#050508] px-3 py-1 text-xs text-cyan-400 border border-cyan-500/30 rounded-full shadow-[0_0_15px_rgba(0,255,242,0.2)] whitespace-nowrap">
          {am.orbitMid1}
        </div>
        <div class="absolute bottom-[15%] left-[10%] bg-[#050508] px-3 py-1 text-xs text-slate-300 border border-slate-700 rounded-full whitespace-nowrap">
          {am.orbitMid2}
        </div>
        <!-- fix #4: middle orbit particles (3 cyan) -->
        <div class="absolute top-1/2 left-0 w-2 h-2 bg-cyan-400 rounded-full shadow-[0_0_8px_#00fff2]"></div>
        <div class="absolute top-0 left-1/2 w-2 h-2 bg-cyan-400/60 rounded-full"></div>
        <div class="absolute bottom-1/2 right-0 w-2 h-2 bg-cyan-400 rounded-full shadow-[0_0_8px_#00fff2]"></div>
      </div>
      <!-- Inner orbit (fix #5: 240/280px + fix #6: Ctx Injection label) -->
      <div class="orbit-ring w-[240px] h-[240px] lg:w-[280px] lg:h-[280px] border-primary/40 border-dashed" style="animation: orbit-spin 8s linear infinite;">
        <div class="absolute -top-4 left-1/2 -translate-x-1/2 bg-surface-lighter px-2 py-0.5 text-[10px] text-white font-mono border border-primary/50 rounded">{am.orbitInner1}</div>
        <div class="absolute top-1/2 -right-4 translate-y-1/2 bg-[#050508] px-2 py-1 text-[10px] text-slate-400 border border-slate-800 rounded whitespace-nowrap">
          {am.orbitInner2}
        </div>
      </div>
      <!-- Core -->
      <div class="relative z-20 flex flex-col items-center justify-center w-40 h-40 rounded-full bg-surface-dark border border-white/10 shadow-[0_0_60px_-10px_rgba(55,19,236,0.4)] animate-pulse-glow">
        <div class="absolute inset-0 rounded-full bg-gradient-to-tr from-primary/20 to-cyan-500/10 blur-xl"></div>
        <div class="w-16 h-16 text-white relative z-10 mb-2">
          <svg class="w-full h-full drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 4C25.7818 14.2173 33.7827 22.2182 44 24C33.7827 25.7818 25.7818 33.7827 24 44C22.2182 33.7827 14.2173 25.7818 4 24C14.2173 22.2182 22.2182 14.2173 24 4Z" fill="currentColor"></path>
          </svg>
        </div>
        <span class="text-xs font-bold tracking-widest text-white uppercase" style="text-shadow: 0 0 10px rgba(0, 240, 255, 0.5);">{am.coreLabel}</span>
        <span class="text-[10px] text-slate-500 font-mono mt-1">{am.coreVersion}</span>
      </div>
      <!-- fix #9: SVG connection lines -->
      <svg class="absolute inset-0 w-full h-full pointer-events-none opacity-20" xmlns="http://www.w3.org/2000/svg">
        <line stroke="#7c3aed" stroke-width="1" x1="50%" x2="80%" y1="50%" y2="20%"></line>
        <line stroke="#00fff2" stroke-width="1" x1="50%" x2="20%" y1="50%" y2="80%"></line>
        <circle cx="80%" cy="20%" fill="#7c3aed" r="2"></circle>
        <circle cx="20%" cy="80%" fill="#00fff2" r="2"></circle>
      </svg>
    </div>

    <div class="absolute top-10 left-10 hidden lg:block">
      <h1 class="text-3xl font-bold text-white mb-2 tracking-tight">{am.title}</h1>
      <p class="text-slate-400 text-sm max-w-xs">{am.subtitle}</p>
    </div>

    <div class="absolute bottom-10 left-10 flex gap-6 text-xs text-slate-500 font-mono hidden lg:flex">
      <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-cyan-400 shadow-[0_0_5px_#00fff2]"></span> {am.legendRealtime}</div>
      <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-purple-500 shadow-[0_0_5px_#bc13fe]"></span> {am.legendPersist}</div>
      <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-primary shadow-[0_0_5px_#3713ec]"></span> {am.legendContext}</div>
    </div>
  </div>

  <!-- Right: Metrics & Logs -->
  <aside class="w-full lg:w-96 bg-surface-dark border-l border-white/5 flex flex-col z-20 shrink-0 h-auto lg:h-[calc(100vh-64px)] overflow-y-auto">
    <!-- Metrics -->
    <div class="p-6 border-b border-white/5">
      <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
        <span class="material-symbols-outlined text-sm">monitoring</span>
        {am.writeLatency}
      </h3>
      <div class="grid grid-cols-2 gap-4">
        <div class="panel-glass rounded-xl p-4 relative overflow-hidden group">
          <div class="absolute top-0 right-0 w-16 h-16 bg-cyan-400/5 blur-xl rounded-full"></div>
          <div class="text-[10px] text-slate-500 uppercase mb-1">P99 Latency</div>
          <div class="text-2xl font-mono font-bold text-white flex items-baseline gap-1">0.12 <span class="text-xs text-cyan-400 font-normal">ms</span></div>
          <div class="mt-2 h-1 w-full bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-cyan-400 w-[20%] animate-pulse"></div></div>
        </div>
        <div class="panel-glass rounded-xl p-4 relative overflow-hidden group">
          <div class="absolute top-0 right-0 w-16 h-16 bg-purple-500/5 blur-xl rounded-full"></div>
          <div class="text-[10px] text-slate-500 uppercase mb-1">{am.recall}</div>
          <div class="text-2xl font-mono font-bold text-white flex items-baseline gap-1">99.8 <span class="text-xs text-purple-400 font-normal">%</span></div>
          <div class="mt-2 h-1 w-full bg-slate-800 rounded-full overflow-hidden"><div class="h-full bg-purple-500 w-[98%]"></div></div>
        </div>
      </div>
      <div class="mt-4 panel-glass rounded-xl p-4">
        <div class="flex justify-between items-center mb-2">
          <span class="text-[10px] text-slate-500 uppercase">{am.tokenLabel}</span>
          <span class="text-xs text-green-400 font-mono">{am.tokenChange}</span>
        </div>
        <div class="flex items-end gap-1 h-8">
          <div class="flex-1 bg-primary/20 rounded-t-sm h-[40%]"></div>
          <div class="flex-1 bg-primary/30 rounded-t-sm h-[60%]"></div>
          <div class="flex-1 bg-primary/40 rounded-t-sm h-[30%]"></div>
          <div class="flex-1 bg-primary/50 rounded-t-sm h-[80%]"></div>
          <div class="flex-1 bg-primary/60 rounded-t-sm h-[50%]"></div>
          <div class="flex-1 bg-primary/80 rounded-t-sm h-[90%]"></div>
          <div class="flex-1 bg-cyan-400 rounded-t-sm h-[75%] shadow-[0_0_10px_rgba(0,255,242,0.3)]"></div>
        </div>
      </div>
    </div>

    <!-- Logs -->
    <div class="p-6 border-b border-white/5 flex-1 min-h-[200px]">
      <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
        <span class="material-symbols-outlined text-sm">terminal</span>
        {am.logTitle}
      </h3>
      <div class="space-y-3 font-mono text-[11px] leading-relaxed">
        {am.logs.map((log: { time: string; level: string; msg: string }) => (
          <div class="flex gap-2">
            <span class="text-slate-600">{log.time}</span>
            <span class={log.level === 'INFO' ? 'text-cyan-400' : log.level === 'MEM' || log.level === 'EMB' ? 'text-purple-400' : log.level === 'OK' || log.level === 'KV' ? 'text-green-400' : 'text-slate-500'}>[{log.level}]</span>
            <span class="text-slate-300">{log.msg}</span>
          </div>
        ))}
      </div>
    </div>

    <!-- Code -->
    <div class="p-6 bg-[#0a0a0e]">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-xs font-semibold text-slate-400 uppercase tracking-widest">Integration</h3>
        <span class="text-[10px] bg-white/5 text-slate-400 px-2 py-0.5 rounded border border-white/5">{am.codeTitle}</span>
      </div>
      <div class="relative group rounded-lg overflow-hidden border border-white/10 bg-[#050508]">
        <pre class="p-4 overflow-x-auto text-xs font-mono text-slate-300"><code><span class="text-purple-400">from</span> talon <span class="text-purple-400">import</span> TalonDB
<span class="text-slate-500"># Initialize Memory Engine</span>
db = TalonDB(api_key=<span class="text-green-400">"..."</span>)
<span class="text-slate-500"># Retrieve Session Context</span>
memory = db.<span class="text-blue-400">ai</span>().<span class="text-yellow-300">get_memory</span>(
    session_id=<span class="text-green-400">"user_123"</span>,
    top_k=<span class="text-orange-400">5</span>
)</code></pre>
      </div>
      <a href={docsUrl} target="_blank" rel="noopener" class="mt-4 w-full py-2 bg-primary hover:bg-primary/90 text-white text-xs font-bold uppercase tracking-wider rounded border border-primary/50 shadow-[0_0_15px_rgba(55,19,236,0.3)] transition-all flex items-center justify-center">
        {am.cta}
      </a>
    </div>
  </aside>
</main>
