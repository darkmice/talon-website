---
import { getLocaleFromUrl, getTranslations, getLocalizedPath, getDocsUrl } from '../i18n';
import { sdkExamples } from '../data/sdk-examples';

const locale = getLocaleFromUrl(Astro.url);
const t = getTranslations(locale);
const sdk = t.sdk;
const p = (path: string) => getLocalizedPath(path, locale);
const docsUrl = getDocsUrl('/guide/getting-started', locale);

const langKeys = ['Go', 'Rust', 'Python', 'Node.js', 'Java', 'C/C++', '.NET'];
const badges: Record<string, string> = { Go: 'Go 1.21+', Rust: 'Rust 2021', Python: 'Python 3.9+', 'Node.js': 'Node 18+', Java: 'Java 17+', 'C/C++': 'C11 / C++17', '.NET': '.NET 8+' };

// Build JSON data for client-side example switching
const exDataForJson: Record<string, Array<{file: string, code: string, runCmd: string, output: string}>> = {};
langKeys.forEach((key, i) => {
  exDataForJson[String(i)] = sdkExamples[key];
});
const exJsonStr = JSON.stringify(exDataForJson);

// SSR: render first example of each language
const langs = langKeys.map(key => {
  const ex0 = sdkExamples[key][0];
  return { key, badge: badges[key], file: ex0.file, code: ex0.code, runCmd: ex0.runCmd, output: ex0.output };
});

---

<style is:global>
  .code-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
  .code-scroll::-webkit-scrollbar-track { background: #0B0E14; }
  .code-scroll::-webkit-scrollbar-thumb { background: #2D3139; border-radius: 4px; }
  .code-scroll::-webkit-scrollbar-thumb:hover { background: #4B5563; }
  .sdk-tab-active { position: relative; color: white !important; }
  .sdk-tab-active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background-color: #3713ec; box-shadow: 0 -2px 10px #3713ec; }
  .tc-kw { color: #c084fc; }
  .tc-str { color: #4ade80; }
  .tc-fn { color: #facc15; }
  .tc-ty { color: #60a5fa; }
  .tc-ac { color: #818cf8; }
  .tc-cm { color: #64748b; }
  .tc-num { color: #fb923c; }
  .tc-info { color: #3b82f6; }
  .tc-ok { color: #22c55e; }
</style>

<main class="flex-grow pt-32 pb-12 relative z-0">
  <div class="absolute inset-0 bg-grid-pattern cyber-grid opacity-20 pointer-events-none fixed -z-10"></div>
  <div class="absolute inset-0 bg-radial-glow pointer-events-none fixed -z-10"></div>

  <div class="container mx-auto px-4 max-w-7xl">
    <!-- Hero -->
    <div class="text-center max-w-4xl mx-auto mb-16">
      <h1 class="text-4xl md:text-6xl font-black text-white mb-6 tracking-tight">
        {sdk.title}<span class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-accent">{sdk.titleHighlight}</span>
      </h1>
      <p class="text-lg text-slate-400 max-w-2xl mx-auto leading-relaxed whitespace-pre-line">{sdk.subtitle}</p>
      <div class="flex justify-center gap-4 mt-8">
        <a class="inline-flex items-center gap-2 text-primary hover:text-accent transition-colors font-medium" href={docsUrl} target="_blank" rel="noopener">
          {sdk.docsLink} <span class="material-symbols-outlined text-sm">arrow_forward</span>
        </a>
      </div>
    </div>

    <!-- Language Tabs -->
    <div class="flex justify-center mb-8 border-b border-white/10 overflow-x-auto" id="sdk-tabs">
      <div class="flex space-x-8 px-4">
        {langs.map((l, i) => (
          <button
            data-tab-index={i}
            class={`flex items-center gap-2 pb-4 text-sm font-medium transition-colors whitespace-nowrap cursor-pointer ${i === 0 ? 'sdk-tab-active text-white' : 'text-slate-400 hover:text-white'}`}
          >
            {l.key}
          </button>
        ))}
      </div>
    </div>

    <!-- IDE Panels (all rendered, only first visible) -->
    {langs.map((l, i) => (
      <div class={`sdk-panel rounded-xl border border-white/10 bg-[#0a0a0f] overflow-hidden shadow-2xl flex flex-col md:flex-row h-[650px] ${i === 0 ? '' : 'hidden'}`} data-panel-index={i}>
        <!-- Sidebar -->
        <div class="w-full md:w-64 bg-[#0c0c14] border-r border-white/10 flex-shrink-0 flex flex-col">
          <div class="p-4 text-xs font-mono text-slate-500 uppercase tracking-wider border-b border-white/10">
            Examples
          </div>
          <div class="overflow-y-auto flex-1 p-2 space-y-1">
            {sdk.examples.map((ex: string, j: number) => (
              <button
                data-ex-index={j}
                class={`sdk-ex-btn w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-all cursor-pointer ${j === 0 ? 'text-white bg-[#16162a] border border-[#3713ec]/30 flex items-center justify-between' : 'text-slate-400 hover:text-white hover:bg-white/5 border border-transparent'}`}
              >
                {ex}
                {j === 0 && <span class="sdk-ex-dot w-2 h-2 rounded-full bg-[#3713ec] shadow-[0_0_8px_#3713ec]" />}
              </button>
            ))}
          </div>
          <div class="p-4 border-t border-white/10">
            <a class="flex items-center justify-center gap-2 w-full py-2 text-xs font-medium text-slate-400 border border-white/10 rounded hover:bg-white/5 transition-colors" href="#">
              <span class="material-symbols-outlined text-sm">open_in_new</span>
              {sdk.pypiLink}
            </a>
          </div>
        </div>

        <!-- Code Editor -->
        <div class="flex-1 flex flex-col min-w-0 bg-[#0e1016]">
          <div class="h-10 border-b border-white/10 flex items-center justify-between px-4 bg-[#0a0a0f]">
            <div class="flex items-center gap-2">
              <span class="w-3 h-3 rounded-full bg-red-500/20 border border-red-500/50"></span>
              <span class="w-3 h-3 rounded-full bg-yellow-500/20 border border-yellow-500/50"></span>
              <span class="w-3 h-3 rounded-full bg-green-500/20 border border-green-500/50"></span>
              <span class="ml-2 text-xs text-slate-500 font-mono sdk-filename">{l.file}</span>
            </div>
          </div>
          <div class="flex-1 overflow-auto code-scroll p-6 font-mono text-sm leading-relaxed relative group">
            <div class="absolute right-6 top-6 opacity-0 group-hover:opacity-100 transition-opacity">
              <span class="bg-[#3713ec]/20 text-[#3713ec] text-[10px] px-2 py-1 rounded border border-[#3713ec]/30">
                {l.badge}
              </span>
            </div>
            <pre><code class="text-slate-300 sdk-code" set:html={l.code} /></pre>
          </div>
        </div>

        <!-- Output Console -->
        <div class="w-full md:w-80 bg-[#0d0d12] border-l border-white/10 flex-shrink-0 flex flex-col font-mono text-xs">
          <div class="h-10 border-b border-white/10 flex items-center px-4 bg-[#0a0a0f] text-slate-500">
            <span class="material-symbols-outlined text-[16px] mr-2">terminal</span>
            Output / Console
          </div>
          <div class="p-4 flex-1 overflow-y-auto code-scroll text-slate-300">
            <div class="mb-2 text-slate-500 sdk-runcmd">{l.runCmd}</div>
            <div class="sdk-output" set:html={l.output} />
          </div>
        </div>
      </div>
    ))}

    <!-- Highlights -->
    <div class="grid md:grid-cols-3 gap-6 mt-12">
      {sdk.highlights.map((h: any, i: number) => {
        const icons = ['speed', 'security', 'hub'];
        const colors = ['primary', 'accent', 'secondary'];
        return (
          <div class="p-6 rounded-xl border border-white/10 bg-surface-lighter/50 hover:bg-surface-lighter hover:border-primary/50 transition-all group">
            <div class={`w-10 h-10 rounded-lg bg-${colors[i]}/10 flex items-center justify-center text-${colors[i]} mb-4 group-hover:scale-110 transition-transform`}>
              <span class="material-symbols-outlined">{icons[i]}</span>
            </div>
            <h3 class="text-lg font-bold text-white mb-2">{h.title}</h3>
            <p class="text-sm text-slate-400">{h.desc}</p>
          </div>
        );
      })}
    </div>

    <!-- CTA -->
    <div class="mt-16 text-center pb-12">
      <h2 class="text-2xl font-bold text-white mb-4">{sdk.cta}</h2>
      <div class="flex justify-center gap-4">
        <a href={p('/download')} class="h-10 px-6 rounded-lg bg-white text-black font-semibold hover:bg-slate-200 transition-colors flex items-center">{sdk.ctaStart}</a>
        <a href={docsUrl} target="_blank" rel="noopener" class="h-10 px-6 rounded-lg border border-white/10 text-slate-300 hover:text-white hover:border-white transition-colors flex items-center">{sdk.ctaDocs}</a>
      </div>
    </div>
  </div>
</main>

<script is:inline type="application/json" id="sdk-ex-data" set:html={exJsonStr}></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabs = document.querySelectorAll('#sdk-tabs button[data-tab-index]');
    const panels = document.querySelectorAll('.sdk-panel[data-panel-index]');
    let activeEx = 0;
    let activeLang = 0;

    // Load examples data
    const exDataEl = document.getElementById('sdk-ex-data');
    const exData = exDataEl ? JSON.parse(exDataEl.textContent || '{}') : {};

    // --- Language tab switching ---
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const idx = tab.getAttribute('data-tab-index');
        activeLang = parseInt(idx || '0');

        tabs.forEach(t => {
          t.classList.remove('sdk-tab-active', 'text-white');
          t.classList.add('text-slate-400');
        });
        tab.classList.add('sdk-tab-active', 'text-white');
        tab.classList.remove('text-slate-400');

        panels.forEach(p => {
          if (p.getAttribute('data-panel-index') === idx) {
            p.classList.remove('hidden');
          } else {
            p.classList.add('hidden');
          }
        });

        // Apply current example to newly visible panel
        applyExample(activeLang, activeEx);
      });
    });

    // --- Example switching ---
    document.querySelectorAll('.sdk-ex-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const exIdx = parseInt(btn.getAttribute('data-ex-index') || '0');
        activeEx = exIdx;

        // Update ALL panels' sidebar active state
        document.querySelectorAll('.sdk-panel').forEach(panel => {
          panel.querySelectorAll('.sdk-ex-btn').forEach((b, j) => {
            if (j === exIdx) {
              b.className = 'sdk-ex-btn w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-all cursor-pointer text-white bg-[#16162a] border border-[#3713ec]/30 flex items-center justify-between';
              // Add dot if not present
              if (!b.querySelector('.sdk-ex-dot')) {
                const dot = document.createElement('span');
                dot.className = 'sdk-ex-dot w-2 h-2 rounded-full bg-[#3713ec] shadow-[0_0_8px_#3713ec]';
                b.appendChild(dot);
              }
            } else {
              b.className = 'sdk-ex-btn w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-all cursor-pointer text-slate-400 hover:text-white hover:bg-white/5 border border-transparent';
              const dot = b.querySelector('.sdk-ex-dot');
              if (dot) dot.remove();
            }
          });
        });

        // Update code/output in ALL panels
        panels.forEach((panel, li) => {
          applyExample(li, exIdx);
        });
      });
    });

    function applyExample(langIdx, exIdx) {
      const langData = exData[String(langIdx)];
      if (!langData || !langData[exIdx]) return;
      const ex = langData[exIdx];
      const panel = document.querySelector(`.sdk-panel[data-panel-index="${langIdx}"]`);
      if (!panel) return;

      const codeEl = panel.querySelector('.sdk-code');
      const outEl = panel.querySelector('.sdk-output');
      const runEl = panel.querySelector('.sdk-runcmd');
      const fileEl = panel.querySelector('.sdk-filename');

      if (codeEl) codeEl.innerHTML = ex.code;
      if (outEl) outEl.innerHTML = ex.output;
      if (runEl) runEl.textContent = ex.runCmd;
      if (fileEl) fileEl.textContent = ex.file;
    }
  });
</script>
